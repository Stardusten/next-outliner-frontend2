import{_ as R,k as K}from"./CardFooter.vue_vue_type_script_setup_true_lang-eOfy4FTl.js";import{_ as V,a as F,b as j,c as O,p as P}from"./SelectTrigger.vue_vue_type_script_setup_true_lang-Cma0zh5R.js";import{b as T,d as M,e as k,u as B,o as d,f as m,g as e,S as H,K as A,r as D,w as n,a,h as v,t as u,i as g,j as N,k as b,c as x,X as S,l as W,F as X,m as q,n as G,R as J,z as Q}from"./index-DgbYwIvn.js";import{_ as $,L as h,a as w,C as Y}from"./Input.vue_vue_type_script_setup_true_lang-9lKhZL8M.js";import{_ as Z,a as ee,b as le,c as ae,d as se}from"./CardTitle.vue_vue_type_script_setup_true_lang-DeW3jETZ.js";import{_ as L}from"./Label.vue_vue_type_script_setup_true_lang-DiM_UGrc.js";import{R as te}from"./refresh-ccw-Dhr5OiqT.js";/**
* @license lucide-vue-next v0.452.0 - ISC
*
* This source code is licensed under the ISC license.
* See the LICENSE file in the root directory of this source tree.
*/const ne=T("CircleCheckIcon",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]),oe={class:"grid items-center w-full gap-4"},ie={class:"flex flex-col space-y-3"},ue={class:"relative"},ce={class:"absolute right-3 top-3"},re={key:0,class:"flex items-center text-red-500 text-sm"},de=["innerHTML"],ve={class:"flex flex-col space-y-2"},ge={class:"flex items-center gap-2"},me={class:"text-xs text-gray-500"},fe={class:"flex flex-col space-y-2"},pe={key:0,class:"text-red-500 text-sm flex items-center"},be=M({__name:"KbEditorLoginView",setup(ke){const{serverUrl:o,token:U}=H.useContext(),_=k(""),c=k(void 0),{kbs:f,refreshKbList:E}=A.useContext(),t=k("invalidURL"),r=k("idle"),{toast:z}=B(),C=q(async()=>{const l=o.value;if(!Q.string().url().safeParse(o.value).success){console.log("URL \u683C\u5F0F\u4E0D\u6B63\u786E"),t.value="invalidURL";return}t.value="connecting";const s=await P({});l===o.value&&(s.success?(t.value="connSuccess",y()):t.value="connFailed")}),y=(l=!1)=>{const s=o.value;E(s,()=>{if(s===o.value&&(Object.keys(f.value).length>0?c.value=Object.keys(f.value)[0]:t.value="noKbServer",l)){const p=Object.keys(f.value).length;z({title:"\u5237\u65B0\u77E5\u8BC6\u5E93\u5217\u8868\u6210\u529F",description:`\u670D\u52A1\u5668 ${o.value} \u4E0A\u6709 ${p} \u4E2A\u77E5\u8BC6\u5E93`})}},()=>{t.value="connFailed"})},I=async()=>{if(!c.value)return;r.value="loggingIn";const l=await K({location:c.value,password:_.value,serverUrl:o.value});l.success?(r.value="loginSuccess",U.value=l.data.token,setTimeout(()=>{const s=encodeURIComponent(o.value),p=encodeURIComponent(c.value);G.push(`/kb/${s}/${p}`)},1e3)):r.value=l.code===J.PASSWORD_INCORRECT?"loginFailed_InvalidPassword":"loginFailed_Unknown"};return(l,s)=>{const p=D("router-link");return d(),m(e(se),{class:"w-[400px] z-10"},{default:n(()=>[a(e(le),null,{default:n(()=>[a(e(Z),null,{default:n(()=>[v(u(l.$t("login.kbEditorLogin.title")),1)]),_:1}),a(e(ee))]),_:1}),a(e(ae),null,{default:n(()=>[g("div",oe,[g("div",ie,[a(e(L),null,{default:n(()=>[v(u(l.$t("login.kbEditorLogin.serverUrlLabel")),1)]),_:1}),g("div",ue,[a(e($),{modelValue:e(o),"onUpdate:modelValue":s[0]||(s[0]=i=>N(o)?o.value=i:null),placeholder:l.$t("login.kbEditorLogin.serverUrlPlaceholder"),onInput:e(C)},null,8,["modelValue","placeholder","onInput"]),g("div",ce,[["connSuccess","noKbServer"].includes(t.value)?(d(),m(e(ne),{key:0,class:"size-4 text-green-600"})):t.value==="connecting"?(d(),m(e(h),{key:1,class:"size-4 animate-spin text-gray-500"})):b("",!0)])]),e(o).length>0&&!["connSuccess","connecting","noKbServer"].includes(t.value)?(d(),x("div",re,[a(e(S),{class:"size-4 mr-2"}),v(" "+u(l.$t(`login.kbEditorLogin.serverStatus.${t.value}`)),1)])):b("",!0),t.value==="noKbServer"?(d(),x("span",{key:1,class:"text-blue-500 text-sm",innerHTML:l.$t("login.kbEditorLogin.noKbServerMsg")},null,8,de)):b("",!0)]),g("div",ve,[a(e(L),null,{default:n(()=>[v(u(l.$t("login.kbEditorLogin.kbLocationLabel")),1)]),_:1}),g("div",ge,[a(e(V),{disabled:t.value!=="connSuccess","model-value":c.value,"onUpdate:modelValue":s[1]||(s[1]=i=>c.value=i)},{default:n(()=>[a(e(F),null,{default:n(()=>[v(u(c.value?e(f)[c.value].name:"-"),1)]),_:1}),a(e(j),null,{default:n(()=>[(d(!0),x(X,null,W(Object.values(e(f)),i=>(d(),m(e(O),{key:i.location,value:i.location},{default:n(()=>[g("div",null,[v(u(i.name)+" ",1),g("div",me,u(i.location),1)])]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["disabled","model-value"]),a(e(w),{variant:"outline",disabled:t.value!=="connSuccess",onClick:s[2]||(s[2]=i=>y(!0)),class:"size-10 p-2",tooltip:l.$t("login.kbEditorLogin.refreshKbListTooltip")},{default:n(()=>[a(e(te),{class:"size-4"})]),_:1},8,["disabled","tooltip"])])]),g("div",fe,[a(e(L),null,{default:n(()=>[v(u(l.$t("login.kbEditorLogin.passwordLabel")),1)]),_:1}),a(e($),{modelValue:_.value,"onUpdate:modelValue":s[3]||(s[3]=i=>_.value=i),type:"password",disabled:t.value!=="connSuccess"||!c.value,onInput:s[4]||(s[4]=i=>r.value="idle")},null,8,["modelValue","disabled"]),r.value==="loginFailed_InvalidPassword"||r.value==="loginFailed_Unknown"?(d(),x("div",pe,[a(e(S),{class:"size-4 mr-2"}),v(" "+u(l.$t(`login.kbEditorLogin.loginStatus.${r.value}`)),1)])):b("",!0)])])]),_:1}),a(e(R),{class:"flex justify-center gap-8"},{default:n(()=>[a(p,{to:"/login/admin",class:"text-sm text-muted-foreground hover:text-foreground transition-colors duration-300"},{default:n(()=>[v(u(l.$t("login.kbEditorLogin.adminLoginBtn")),1)]),_:1}),a(e(w),{class:"min-w-[100px]",onClick:I,disabled:t.value!=="connSuccess"||!c.value},{default:n(()=>[r.value==="loggingIn"?(d(),m(e(h),{key:0,class:"size-4 mr-2 animate-spin"})):r.value==="loginSuccess"?(d(),m(e(Y),{key:1,class:"size-4 mr-2"})):b("",!0),v(" "+u(l.$t(`login.kbEditorLogin.loginBtn.${r.value}`)),1)]),_:1},8,["disabled"])]),_:1})]),_:1})}}});export{be as default};
